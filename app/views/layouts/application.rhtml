<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
  <!-- TODO: helper for content type? -->
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

  <% cached_controllers = ['audio', 'documents', 'images', 'topics', 'video', 'web_links'] %>
  <% if cached_controllers.include?(params[:controller]) and params[:action] == "show" %>
    <% item = @audio_recording || @document || @still_image || @topic || @video || @web_link || nil %>
    <% cache_with_privacy(item, {:part => 'page_title'}) do %><title><%= h(@title) %></title><% end -%>
  <% else -%>
    <title><%= h(@title) %></title>
  <% end -%>

  <% # logic for which javascript to load -%>
  <% as_controllers = ACTIVE_SCAFFOLD_CONTROLLERS -%>
  <% none_tinymce_controllers = as_controllers + ['members', 'topic_types', 'content_types'] -%>
  <% tinymce_actions = ['new', 'create', 'edit', 'update',
  'pick_topic_type', 'homepage_options', 'new_related_set_from_archive_file'] -%>
  <% @do_not_use_tiny_mce ||= !(!none_tinymce_controllers.include?(params[:controller]) && tinymce_actions.include?(params[:action])) -%>
  <% unless @do_not_use_tiny_mce -%>
        <% # Include TinyMCE before other JS to avoid problems,
                        # tinymce not compatible with bundle_fu -%>
        <%= javascript_include_tiny_mce_if_used %>
        <%# point tinymce at the correct css file %>
        <% @tiny_mce_options[:content_css] = "/stylesheets/cache/#{@theme}_theme.css" if using_tiny_mce? %>
        <% @tiny_mce_options[:extended_valid_elements] = EXTENDED_VALID_ELEMENTS if @site_admin and using_tiny_mce? %>
        <%= tiny_mce if using_tiny_mce? %>
        <script type="text/javascript">
        function convertWord(type, content) {
            switch (type) { // Gets executed before the built in logic performes it's cleanups
              case "before":
                   content = content.toLowerCase(); // Some dummy logic
                   break;
                   // Gets executed after the built in logic performes it's cleanups
              case "after":
                   content = content.toLowerCase(); // Some dummy logic
                   break;
            }
            return content;
        }
        </script>
  <% end -%>

<%= stylesheet_link_tag 'kete-print', :media => 'print' %>

<% bundle :name => "#{@theme}_theme" do -%>
 <%= stylesheet_link_tag 'base', :media => 'screen' %>
 <%= stylesheet_link_tag 'comment', :media => 'screen' %>
 <%= stylesheet_link_tag 'redbox' %>
 <%= stylesheet_link_tag 'dan_webb_code_highlighter/styles' if !AVAILABLE_SYNTAX_HIGHLIGHTERS.empty? %>
 <% load_styles(@theme).each do |stylesheet| -%>
  <%= stylesheet_link_tag stylesheet, :media => 'screen' %>
 <% end -%>
<% end -%>

<%= stylesheet_link_tag('serif') if @theme_font_family == 'serif' %>

<% if !@header_image.blank? -%>
 <% # allows for banner style background image -%>
 <style type="text/css">
  #header { background: url('<%= @header_image -%>') no-repeat top left !important; }
 </style>

<% end -%>

<%  bundle :name => "rails_defaults" do -%>
  <%= javascript_include_tag :defaults %>
  <%= javascript_include_tag 'redbox' %>
  <% if !AVAILABLE_SYNTAX_HIGHLIGHTERS.empty? %>
    <%= javascript_include_tag 'dan_webb_code_highlighter/code_highlighter' %>
    <% AVAILABLE_SYNTAX_HIGHLIGHTERS.each do |syntax| %>
      <%= javascript_include_tag "dan_webb_code_highlighter/#{syntax}" %>
    <% end %>
  <% end %>
<% end -%>

  <% if as_controllers.include?(params[:controller]) -%>
   <%  bundle :name => "active_scaffold" do -%>
        <%= active_scaffold_includes %>
   <% end -%>
  <% end -%>

  <% if !@rss_tag_auto.nil?  -%>
        <%= @rss_tag_auto %>
  <% end -%>
  <!--[if IE]><%= stylesheet_link_tag 'kete-ie', :media => 'screen' %><![endif]-->

</head>
<body id="<%= @current_basket.urlified_name -%>">
<% if IS_CONFIGURED -%>
<div id="body-outer-wrapper">
  <div id="body-inner-wrapper">
    <div id="header-wrapper">
      <div id="header">
            <!-- this would be a good place for your logo -->
            <h1><%= link_to PRETTY_SITE_NAME, '/' -%><%= header_link_to_current_basket -%></h1>
            <div id="head-search-wrapper">
                    <% form_tag :overwrite_params => { :action => 'terms_to_page_url_redirect',
                                                       :controller => 'search',
                                                       :page => nil,
                                                       :sort_type => nil,
                                                       :sort_direction => nil,
                                                       :urlified_name => @site_basket.urlified_name,
                                                       :search_terms => nil } do %>
                              <div class="wrap"><label for="search_terms">Search:</label>
                              <%= text_field_tag 'search_terms'  %>
                              <%= submit_tag 'Go' %></div>
                      <% end -%>
            </div>
        <%= header_links_to_baskets %>
      </div>
    </div>

    <div id="top-menu">
      <ul class="user-nav nav-list">
        <% if !logged_in? %>
        <li class="first"><%= link_to_unless_current "Register", :controller => 'account',
          :action => :signup,
          :urlified_name => @site_basket.urlified_name -%></li>
        <li><%= link_to_unless_current "Login", :controller => 'account',
          :action => :login,
          :urlified_name => @site_basket.urlified_name -%></li>
        <!-- Logout -->
        <% else %>
        <li class="first"><%= link_to_unless_current current_user.user_name, :controller => 'account',
          :action => 'show',
          :urlified_name => @site_basket.urlified_name -%></li>
        <li><%= link_to_unless_current "Logout", :controller => 'account',
          :action => :logout,
          :urlified_name => @site_basket.urlified_name -%></li>
        <% end %>
      </ul>
      <ul id="main-nav" class="nav-list">
        <li class="first"><a href="/">Home</a></li>
        <%= header_browse_links %>
        <li><%= link_to_unless_current(h(@about_basket.name),
                basket_index_url(:urlified_name => @about_basket.urlified_name)) %></li>
        <li><%= link_to_unless_current(h(@help_basket.name),
                basket_index_url(:urlified_name => @help_basket.urlified_name)) %></li>
        <li><%= mail_to(CONTACT_EMAIL,'Contact', :encode => "hex") %></li>
        <%= header_add_links %>
      </ul>
    </div> <!-- /header -->

    <% if flash[:notice] %>
    <div id="notice"><div><%= flash[:notice] %></div></div>
    <% end %>
    <% if flash[:error] %>
    <div id="error"><div><%= flash[:error] %></div></div>
    <% end %>

        <div id="container">
          <% if USES_BASKET_LIST_NAVIGATION_MENU_ON_EVERY_PAGE %>
          <div id="basket-list-column">
          <%= render_baskets_as_menu %>
          </div>
          <% end %>

          <% if render_full_width_content_wrapper? and !@displaying_404 %>
             <%= render(:partial => "topics/content_wrapper_start" , :locals => { :style_classes =>"full-width notabs" }) %>
          <% end %>
          <%= @content_for_layout %>
        </div><!--  /container -->
        <div class="cleaner">&nbsp;</div>
        <div id="footer">
                <!--Footer-->
                <% if !@rss_tag_link.nil? -%>
                        <div id="linkToRSS"><%= @rss_tag_link -%>RSS feed for
                these items</a></div>
                <% end -%>
                <% if logged_in? and @basket_admin and !@displaying_404 -%>
                        <div id="basket-toolbox">
                                <h4>Tools for basket: <%= h(@current_basket.name) -%></h4>
                                <ul>
                                <li class="first"><%= link_to_unless_current "basket preferences",
                                                                              :id => @current_basket,
                                                                              :controller => '/baskets',
                                                                              :action => :edit -%></li>
                                <li><%= link_to_unless_current "moderate basket contents",
                                                                :controller => '/moderate',
                                                                :action => :list -%></li>
                                <li><%= link_to_unless_current "basket members",
                                                                :controller => '/members',
                                                                :action => :list -%></li>
                                <% # when this is more refined, may open this up to non-tech-admins -%>
                                <% if @tech_admin -%>
                                                                <li><%= link_to_unless_current "import content into basket",
                                                                                                :controller => '/importers',
                                                                                                :action => :list -%></li>
                                <% end %>
                                <% if @current_basket.urlified_name != 'site' -%>
                                        <li><%= link_to_unless_current "delete this basket",
                                                        { :id => @current_basket,
                                                               :controller => '/baskets',
                                                               :action => :destroy },
                                                                :confirm => 'Are you sure? All items in this basket will be deleted forever!', :method => :post -%></li>
                                <% end %>
                                </ul>
                        </div>
                <% end %>
                <% if logged_in? and @site_admin and !@displaying_404 %>
                   <!-- admin toolbox, temp -->
                   <div id="adminToolbox">
                        <h4>Administrator's Toolbox</h4>
                        <p>
                        Controls:
                        <%= link_to_unless_current("add basket", :urlified_name => @site_basket.urlified_name,
                                                               :controller => 'baskets',
                                                               :action => :new) %>
                        |
                        <%= link_to_unless_current "topic types", :controller => '/topic_types',
                                                                  :action => :list,
                                                                  :urlified_name => @site_basket.urlified_name -%>
                        |
                        <%= link_to_unless_current "content types", :controller => '/content_types',
                                                                  :action => :list,
                                                                  :urlified_name => @site_basket.urlified_name -%>
                        |
                        <%= link_to_unless_current "extended fields", :controller => '/extended_fields',
                                                                        :action => :list,
                                                                        :urlified_name => @site_basket.urlified_name -%>
                        |
                        <%= link_to_unless_current "site members", :controller => '/members',
                                                                        :action => :list,
                                                                        :urlified_name => @site_basket.urlified_name -%>
                        |
                        <%= link_to_unless_current "administer licenses", :controller => '/licenses',
                            :action => :index, :urlified_name => @site_basket.urlified_name -%>
                        |
                        <%= link_to_unless_current "List site on Kete.net.nz", :controller => '/configure',
                                                                               :action => 'add_link_from_kete_net',
                                                                               :urlified_name => @site_basket.urlified_name -%>
                        <% if @tech_admin -%>
                        |
                        <%= link_to_unless_current "reconfigure site", :controller => '/configure',
                                                                        :action => :index,
                                                                        :urlified_name => @site_basket.urlified_name -%>
                        |
                        <%= link_to_unless_current "OAI PMH Sets", :controller => '/oai_pmh_repository_sets',
                                                                        :action => :index,
                                                                        :urlified_name => @site_basket.urlified_name -%>
                        |
                        <%= link_to_unless_current "Z39.50 search databases", :controller => '/zoom_dbs',
                                                                              :action => :list,
                                                                              :urlified_name => @site_basket.urlified_name -%>

                        |
                        <%= link_to_unless_current "Rebuild search databases", :controller => '/search',
                                                                              :action => 'setup_rebuild',
                                                                              :urlified_name => @site_basket.urlified_name -%>
                        <% end -%>
                        </p>
                        <p>
                         Support:
                        <%= link_to_unless_current("documentation", basket_index_url(:urlified_name => @documentation_basket.urlified_name)) %>
                        </p>
                   </div>
                <% end %>
        </div>

 </div> <!-- /body-outer-wrapper -->
</div> <!-- /body-inner-wrapper -->


<% else -%>
<div id="body-outer-wrapper">
  <div id="body-inner-wrapper">



    <div id="wrapper">
        <div id="header">
                <h1><%= PRETTY_SITE_NAME -%></h1>
        </div><!-- /header -->

        <div class="cleaner">&nbsp;</div>

        <% if flash[:notice] %>
           <!-- TODO: look up if there is a style sheet class for flash, add here -->
           <div id="notice"><div><%= flash[:notice] %></div></div>
        <% end %>

        <%= render(:partial => "topics/content_wrapper_start" , :locals => { :style_classes =>
"full-width notabs" }) %>



        <div id="container">

                        <%= @content_for_layout %>

        </div><!--  /container -->
        <div class="cleaner">&nbsp;</div>
        <div id="footer">
                <!--Footer-->
        </div>
</div><!-- /wrapper -->

</div>
</div>
<% end -%>
</body>
</html>
